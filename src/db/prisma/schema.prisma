generator client {
  provider = "prisma-client-py"
  recursive_type_depth = 5
  output   = "../src/db/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Profile {
  userId      String   @id
  email       String?
  createdAt   DateTime @default(now())
  Reports     Report[]
  Predictions Prediction[]
  TriageNotes TriageNote[]

  @@map("profiles")
}

model Report {
  id           String       @id @default(uuid())
  userId       String
  task         String // "heart" | "diabetes" | "anemia_tab" | "anemia_img"
  rawFilename  String?
  extracted    Json
  missingFields Json
  warnings     Json
  // New: pipeline artifacts for history & UI confidence
  rawOCR       Json?
  extractedMeta Json?
  createdAt    DateTime     @default(now())
  Predictions  Prediction[]
  Profile      Profile      @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("reports")
}

model Prediction {
  id              String       @id @default(uuid())
  userId          String
  reportId        String?
  task            String
  features        Json
  label           Int
  probability     Float
  healthScore     Float
  topContributors Json
  warnings        Json
  createdAt       DateTime     @default(now())
  Report          Report?      @relation(fields: [reportId], references: [id], onDelete: SetNull)
  Profile         Profile      @relation(fields: [userId], references: [userId], onDelete: Cascade)
  TriageNotes     TriageNote[]

  @@index([userId, createdAt])
  @@map("predictions")
}

model TriageNote {
  id            String     @id @default(uuid())
  userId        String
  predictionId  String
  complaint     String?
  triageSummary String
  followups     Json
  modelName     String?
  createdAt     DateTime   @default(now())
  Prediction    Prediction @relation(fields: [predictionId], references: [id], onDelete: Cascade)
  Profile       Profile    @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("triage_notes")
}


